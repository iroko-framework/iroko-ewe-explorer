<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Plants | Standalone Explorer</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;max-width:980px;margin:40px auto;padding:0 18px;line-height:1.6}
    header{padding:18px 20px;border:1px solid #ddd;border-radius:12px}
    .muted{color:#555}
    ul{padding-left:18px}
    .card{border:1px solid #e5e5e5;border-radius:12px;padding:14px 16px;margin:12px 0}
    .pill{display:inline-block;padding:2px 10px;border-radius:999px;border:1px solid #ddd;font-size:.85rem}
    a{font-weight:600;text-decoration:none}
    a:hover{text-decoration:underline}
    code{background:#f3f3f3;padding:2px 6px;border-radius:6px}
  </style>

  <!-- N3.js Turtle parser (client-side) -->
  <script src="https://unpkg.com/n3@1.20.0/browser/n3.min.js"></script>
</head>
<body>

<header>
  <h1>Plant Records</h1>
  <p class="muted">This page loads <code>data/plants.ttl</code> and renders the plant list.</p>
  <p><a href="./index.html">← Home</a></p>
</header>

<div id="status" class="muted" style="margin-top:14px;">Loading…</div>
<div id="list"></div>

<script>
  const NS = {
    dwcScientificName: "http://rs.tdwg.org/dwc/terms/scientificName",
    skosAltLabel: "http://www.w3.org/2004/02/skos/core#altLabel",
    dctIdentifier: "http://purl.org/dc/terms/identifier",
    exPlantClass: "https://example.org/iroko-db/Plant",
    rdfType: "http://www.w3.org/1999/02/22-rdf-syntax-ns#type"
  };

  function literalValue(term) {
    // N3 literal is like: "text"@yo or "text"^^...
    // N3.js exposes .value and .language on literal terms.
    return term.value;
  }

  async function loadTTL(url) {
    const res = await fetch(url);
    if (!res.ok) throw new Error(`Failed to fetch ${url}: ${res.status}`);
    return await res.text();
  }

  function parseTTL(ttlText) {
    const parser = new N3.Parser();
    const quads = parser.parse(ttlText);
    return quads;
  }

  function buildPlantIndex(quads) {
    // Build map of subject -> properties
    const bySubject = new Map();

    for (const q of quads) {
      const s = q.subject.value;
      const p = q.predicate.value;
      const o = q.object;

      if (!bySubject.has(s)) bySubject.set(s, { uri: s, types: [], sci: null, id: null, yo: [], en: [] });

      const rec = bySubject.get(s);

      if (p === NS.rdfType) rec.types.push(o.value);

      if (p === NS.dwcScientificName && o.termType === "Literal") rec.sci = literalValue(o);
      if (p === NS.dctIdentifier && o.termType === "Literal") rec.id = literalValue(o);

      if (p === NS.skosAltLabel && o.termType === "Literal") {
        const txt = literalValue(o);
        const lang = (o.language || "").toLowerCase();
        if (lang === "yo") rec.yo.push(txt);
        else if (lang === "en") rec.en.push(txt);
      }
    }

    // Filter to actual Plant instances (typed ex:Plant) OR those with scientificName
    const plants = [];
    for (const rec of bySubject.values()) {
      const isPlant = rec.types.includes(NS.exPlantClass) || rec.sci;
      if (isPlant) plants.push(rec);
    }

    // Sort by scientific name
    plants.sort((a,b) => (a.sci || "").localeCompare(b.sci || ""));
    return plants;
  }

  function render(plants) {
    const status = document.getElementById("status");
    const list = document.getElementById("list");

    status.textContent = `Loaded ${plants.length} plant record(s).`;

    list.innerHTML = "";
    for (const p of plants) {
      const yoPreview = p.yo.length ? p.yo.join("; ") : "—";
      const id = encodeURIComponent(p.id || p.uri);

      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML = `
        <div class="pill">${p.id || "Unidentified"}</div>
        <h2 style="margin:10px 0 4px 0;">
          <a href="./plants.html#${id}">${p.sci || "No scientificName"}</a>
        </h2>
        <div class="muted"><strong>Yorùbá:</strong> ${yoPreview}</div>
      `;
      list.appendChild(div);
    }
  }

  (async function main() {
    try {
      const ttl = await loadTTL("./data/plants.ttl");
      const quads = parseTTL(ttl);
      const plants = buildPlantIndex(quads);
      render(plants);
    } catch (e) {
      document.getElementById("status").textContent = "Error: " + e.message;
      console.error(e);
    }
  })();
</script>

</body>
</html>
