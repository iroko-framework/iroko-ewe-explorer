<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="description" content="Iroko Ewé Knowledge Explorer: stewardship-centered linked data for ethically governed ethnobotanical knowledge.">  
  <title>Plants | Iroko Ewé Knowledge Explorer</title>
  <link rel="stylesheet" href="/iroko-ewe-explorer/assets/style.css">
  <style>
    .lang-panel { display: none; }
    .lang-panel.active { display: block; }
  
    .top-nav {
      display: flex;
      gap: 18px;
      flex-wrap: wrap;
      margin: 10px 0 22px 0;
    }
    .top-nav a {
      text-decoration: none;
      font-weight: 600;
    }

    .plant-card {
      border: 1px solid rgba(48,64,32,0.18);
      border-radius: 12px;
      padding: 12px 14px;
      margin: 12px 0;
    }

    .plant-card-header {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .plant-sci { font-weight: 700; }
    .plant-id  { opacity: .75; font-size: .92rem; }
    .plant-syn { opacity: .7; font-size: .9rem; font-style: italic; margin-top: 2px; }

    .plant-names { margin-top: 6px; }
    .plant-name-row { opacity: .85; }
    .plant-name-row.yo { opacity: .9; }

    .primary-form-note {
      font-size: .82rem;
      font-style: italic;
      opacity: .65;
      margin-top: 2px;
      margin-bottom: 4px;
    }

    .plant-collision { margin-top: 8px; }
    .plant-collision ul { margin: 4px 0 0 0; padding-left: 1.4em; }

    .plant-categories { margin-top: 8px; opacity: .85; }

    .plant-ritual-note { margin-top: 6px; }
    .plant-ritual-note ul { margin: 4px 0 0 0; padding-left: 1.4em; }

    .plant-sources { margin-top: 8px; opacity: .85; }
    .plant-source-list { padding-left: 1.5em; margin-top: 3px; }
    .plant-source-item { font-size: .92rem; margin-bottom: 2px; }

    .plant-links { margin-top: 4px; opacity: .85; }
    .plant-uri { opacity: .65; font-size: .9rem; margin-top: 8px; }
  </style>
  <script src="https://unpkg.com/n3@1.20.0/browser/n3.min.js"></script>
</head>

<body>

<header class="iroko-header">
  <div class="header-inner">

    <div class="logo-block">
      <a href="/iroko-ewe-explorer/index.html" aria-label="Return to Homepage">
        <img src="/iroko-ewe-explorer/assets/IHS-Logo.jpg" alt="Iroko Historical Society Logo">
      </a>
    </div>
    
    <div class="header-text">
      <h1>Iroko Ewé Knowledge Explorer</h1>
      <p class="subtitle">Linked Data for Ethically Governed Ethnobotanical Knowledge</p>
      <div class="version-pill">Version 0.2.1 | February 2026</div>

      <div class="lang-buttons" aria-label="Language selector">
        <button type="button" onclick="setLang('en')" id="btn-en">English</button>
        <button type="button" onclick="setLang('es')" id="btn-es">Español</button>
        <button type="button" onclick="setLang('pt')" id="btn-pt">Português</button>
        <button type="button" onclick="setLang('fr')" id="btn-fr">Français</button>
        <button type="button" onclick="setLang('yo')" id="btn-yo">Èdè Yorùbá</button>
      </div>

    </div>
  </div>
</header>

<nav class="top-nav">
  <a href="/iroko-ewe-explorer/index.html">Home</a>
  <a href="/iroko-ewe-explorer/concept/index.html">Controlled Vocabularies</a>
</nav>

<!-- EN -->
<section id="panel-en" class="lang-panel active">
  <h2>Plant Records</h2>
  <p>
    Plant records in this Explorer are structured knowledge nodes within the Iroko Framework.
    Each record integrates botanical classification, multilingual naming traditions,
    and governance-aware metadata.
  </p>
  <p>Each plant page displays:</p>
  <ul>
    <li><strong>Yorùbá name set</strong> (alphabetical; primary form not asserted)</li>
    <li>Scientific name and synonyms (taxonomic reference)</li>
    <li>Multilingual alternate names</li>
    <li>Access level classification</li>
    <li>Medicinal categories</li>
    <li>Ritual categories</li>
    <li>Provenance and external references</li>
  </ul>
  <p>Where applicable, plant records may also link to preserved specimens and herbarium records modeled using Darwin Core occurrence standards.</p>
  <h3>Preview (from data/ewe-plants-v0.2.1.ttl)</h3>
  <p class="muted load-status">Loading plant list…</p>
  <div id="plant-list-en"></div>
</section>

<!-- ES -->
<section id="panel-es" class="lang-panel">
  <h2>Registros de plantas</h2>
  <p>
    Los registros de plantas en este Explorador son nodos de conocimiento estructurados dentro del Iroko Framework.
    Cada registro integra clasificación botánica, tradiciones multilingües de denominación
    y metadatos con gobernanza explícita.
  </p>
  <p>Cada página de planta muestra:</p>
  <ul>
    <li><strong>Conjunto de nombres en yorùbá</strong> (orden alfabético; no se afirma una forma primaria)</li>
    <li>Nombre científico y sinónimos (referencia taxonómica)</li>
    <li>Nombres alternativos multilingües</li>
    <li>Clasificación del nivel de acceso</li>
    <li>Categorías medicinales</li>
    <li>Categorías rituales</li>
    <li>Procedencia y referencias externas</li>
  </ul>
  <p>Cuando corresponda, los registros podrán enlazar a especímenes preservados y registros de herbario modelados con estándares Darwin Core para ocurrencias.</p>
  <h3>Vista previa (data/ewe-plants-v0.2.1.ttl)</h3>
  <p class="muted load-status">Cargando lista de plantas…</p>
  <div id="plant-list-es"></div>
</section>

<!-- PT -->
<section id="panel-pt" class="lang-panel">
  <h2>Registros de plantas</h2>
  <p>
    Os registros de plantas neste Explorador são nós de conhecimento estruturados dentro do Iroko Framework.
    Cada registro integra classificação botânica, tradições multilíngues de nomeação
    e metadados com governança explícita.
  </p>
  <p>Cada página de planta exibirá:</p>
  <ul>
    <li><strong>Conjunto de nomes em yorùbá</strong> (ordem alfabética; nenhuma forma primária é afirmada)</li>
    <li>Nome científico e sinônimos (referência taxonômica)</li>
    <li>Nomes alternativos multilíngues</li>
    <li>Classificação do nível de acesso</li>
    <li>Categorias medicinais</li>
    <li>Categorias rituais</li>
    <li>Proveniência e referências externas</li>
  </ul>
  <p>Quando aplicável, os registros poderão vincular a espécimes preservados e registros de herbário modelados com padrões Darwin Core para ocorrências.</p>
  <h3>Visualização (data/ewe-plants-v0.2.1.ttl)</h3>
  <p class="muted load-status">Carregando lista de plantas…</p>
  <div id="plant-list-pt"></div>
</section>

<!-- FR -->
<section id="panel-fr" class="lang-panel">
  <h2>Notices de plantes</h2>
  <p>
    Les notices de plantes dans cet Explorateur sont des nœuds de connaissance structurés au sein du Iroko Framework.
    Chaque notice intègre une classification botanique, des traditions multilingues de nomination
    et des métadonnées à gouvernance explicite.
  </p>
  <p>Chaque page de plante affiche :</p>
  <ul>
    <li><strong>Ensemble des noms en yorùbá</strong> (ordre alphabétique ; aucune forme primaire n'est affirmée)</li>
    <li>Nom scientifique et synonymes (référence taxonomique)</li>
    <li>Noms alternatifs multilingues</li>
    <li>Classification du niveau d'accès</li>
    <li>Catégories médicinales</li>
    <li>Catégories rituelles</li>
    <li>Provenance et références externes</li>
  </ul>
  <p>Le cas échéant, les notices pourront renvoyer à des spécimens conservés et à des notices d'herbier, modélisés selon les standards Darwin Core (occurrences).</p>
  <h3>Aperçu (data/ewe-plants-v0.2.1.ttl)</h3>
  <p class="muted load-status">Chargement de la liste des plantes…</p>
  <div id="plant-list-fr"></div>
</section>

<!-- YO -->
<section id="panel-yo" class="lang-panel">
  <h2>Àwọn àkọsílẹ̀ ọgbìn</h2>
  <p>
    Àwọn àkọsílẹ̀ ọgbìn nínú Explorer yìí jẹ́ "nódù" ìmọ̀ tí a ṣètò lábẹ́ Iroko Framework.
    Àkọsílẹ̀ kọọkan ń darapọ̀ ìpín ọgbìn (botanical classification), àṣà orúkọ ní ọ̀pọ̀ èdè,
    àti metadátà pẹ̀lú ìṣàkóso tó hàn gbangba.
  </p>
  <p>Ojú-ewé ọgbìn kọọkan yóò fi hàn:</p>
  <ul>
    <li><strong>Àkójọpọ̀ àwọn orúkọ Yorùbá</strong> (ní títò lẹ́sẹ̀sẹ̀ àlùfábẹ́ẹ̀tì; a kò fi ọ̀kan kàn hàn gẹ́gẹ́ bí orúkọ àkọ́kọ́)</li>
    <li>Orúkọ sáyẹ́ǹsì àti àwọn orúkọ mìíràn tó jọra (ìtọ́kasí taxon)</li>
    <li>Àwọn orúkọ míì ní ọ̀pọ̀ èdè</li>
    <li>Ìpele àyèwọ̀lé</li>
    <li>Àwọn ẹ̀ka ìwòsàn</li>
    <li>Àwọn ẹ̀ka ìṣe-ẹ̀mí</li>
    <li>Provenance àti àwọn ìtọ́kasí òde</li>
  </ul>
  <p>Níbi tó bá yẹ, àkọsílẹ̀ ọgbìn lè so mọ́ "preserved specimen" àti àkọsílẹ̀ herbarium tí a ṣe pẹ̀lú ìlànà Darwin Core (occurrence).</p>
  <h3>Àkọsílẹ̀ àkọ́kọ́ (data/ewe-plants-v0.2.1.ttl)</h3>
  <p class="muted load-status">Ń ṣe àkójọ àwọn ọgbìn…</p>
  <div id="plant-list-yo"></div>
</section>


<footer class="footer">
  <a href="/iroko-ewe-explorer/index.html">← Back to Home</a>
</footer>

<script>
  // ── Language toggle ───────────────────────────────────────────
  function setLang(lang) {
    const panels  = document.querySelectorAll(".lang-panel");
    const buttons = document.querySelectorAll(".lang-buttons button");

    panels.forEach(p => p.classList.remove("active"));
    buttons.forEach(b => b.classList.remove("active"));

    const panel = document.getElementById("panel-" + lang);
    const btn   = document.getElementById("btn-" + lang);

    if (panel) panel.classList.add("active");
    if (btn)   btn.classList.add("active");

    document.documentElement.lang = lang;

    // Re-render plants into this panel if not yet done
    if (window._plantsData && !window._renderedLangs.has(lang)) {
      renderPlants(lang, window._plantsData, window._conceptLabels);
    }

    try { localStorage.setItem("iroko_lang", lang); } catch(e) {}
  }

  (function init() {
    let saved = "en";
    try { saved = localStorage.getItem("iroko_lang") || "en"; } catch(e) {}
    setLang(saved);
  })();
</script>

<script>
  // ── UI label dictionary ───────────────────────────────────────
  const LABELS = {
    en: {
      syn:            "Syn",
      yo:             "Yorùbá",
      en:             "English",
      "es-cu":        "Cuba (ES)",
      es:             "Español",
      pt:             "Português",
      fr:             "Français",
      ht:             "Kreyòl ayisyen",
      lucumi:         "Lucumí",
      collision:      "Name collision",
      access:         "Access",
      medicinal:      "Medicinal",
      ritual:         "Ritual",
      ritualNote:     "Ritual context note",
      sources:        "Sources",
      links:          "Links",
      primaryForm:    "Names listed alphabetically; primary form not asserted",
      noSci:          "No scientific name",
      extRecord:      "External record"
    },
    es: {
      syn:            "Sin.",
      yo:             "Yorùbá",
      en:             "Inglés",
      "es-cu":        "Cuba (ES)",
      es:             "Español",
      pt:             "Portugués",
      fr:             "Francés",
      ht:             "Kreyòl ayisyen",
      lucumi:         "Lucumí",
      collision:      "Colisión de nombre",
      access:         "Nivel de acceso",
      medicinal:      "Uso medicinal",
      ritual:         "Uso ritual",
      ritualNote:     "Nota de contexto ritual",
      sources:        "Fuentes",
      links:          "Enlaces",
      primaryForm:    "Nombres en orden alfabético; no se afirma una forma primaria",
      noSci:          "Sin nombre científico",
      extRecord:      "Registro externo"
    },
    pt: {
      syn:            "Sin.",
      yo:             "Yorùbá",
      en:             "Inglês",
      "es-cu":        "Cuba (ES)",
      es:             "Español",
      pt:             "Português",
      fr:             "Français",
      ht:             "Kreyòl ayisyen",
      lucumi:         "Lucumí",
      collision:      "Colisão de nome",
      access:         "Nível de acesso",
      medicinal:      "Uso medicinal",
      ritual:         "Uso ritual",
      ritualNote:     "Nota de contexto ritual",
      sources:        "Fontes",
      links:          "Links",
      primaryForm:    "Nomes em ordem alfabética; nenhuma forma primária é afirmada",
      noSci:          "Sem nome científico",
      extRecord:      "Registro externo"
    },
    fr: {
      syn:            "Syn.",
      yo:             "Yorùbá",
      en:             "Anglais",
      "es-cu":        "Cuba (ES)",
      es:             "Español",
      pt:             "Português",
      fr:             "Français",
      ht:             "Kreyòl ayisyen",
      lucumi:         "Lucumí",
      collision:      "Collision de nom",
      access:         "Niveau d'accès",
      medicinal:      "Usage médicinal",
      ritual:         "Usage rituel",
      ritualNote:     "Note de contexte rituel",
      sources:        "Sources",
      links:          "Liens",
      primaryForm:    "Noms classés par ordre alphabétique ; aucune forme primaire n'est affirmée",
      noSci:          "Sans nom scientifique",
      extRecord:      "Fiche externe"
    },
    yo: {
      syn:            "Orúkọ mìíràn",
      yo:             "Yorùbá",
      en:             "Èdè Gẹ̀ẹ́sì",
      "es-cu":        "Kúbà (ES)",
      es:             "Español",
      pt:             "Português",
      fr:             "Français",
      ht:             "Kreyòl ayisyen",
      lucumi:         "Lucumí",
      collision:      "Ìkọlù orúkọ",
      access:         "Ìpele àyèwọ̀lé",
      medicinal:      "Ìwòsàn",
      ritual:         "Ìṣe-ẹ̀mí",
      ritualNote:     "Àkọsílẹ̀ ìṣe-ẹ̀mí",
      sources:        "Àwọn orisun",
      links:          "Àwọn ìjápọ̀",
      primaryForm:    "Àwọn orúkọ tó ní títò lẹ́sẹ̀sẹ̀ àlùfábẹ́ẹ̀tì; a kò fi ọ̀kan kàn hàn gẹ́gẹ́ bí orúkọ àkọ́kọ́",
      noSci:          "Kò sí orúkọ sáyẹ́ǹsì",
      extRecord:      "Àkọsílẹ̀ òde"
    }
  };

  function L(lang, key) {
    return (LABELS[lang] && LABELS[lang][key]) || (LABELS["en"][key]) || key;
  }

  // ── RDF parsing helpers ───────────────────────────────────────
  async function fetchText(url) {
    const res = await fetch(url);
    if (!res.ok) throw new Error("Could not load " + url + " (HTTP " + res.status + ")");
    return await res.text();
  }

  function pickByLang(map, lang) {
    const order = [lang, "en", "yo", "es", "pt", "fr"];
    for (const l of order) {
      if (map[l] && map[l].length) return map[l];
    }
    return [];
  }

  // ── Card renderer ─────────────────────────────────────────────
  function renderPlants(lang, plants, conceptLabels) {
    const listEl = document.getElementById("plant-list-" + lang);
    if (!listEl) return;

    function labelize(uri) {
      const m = conceptLabels.get(uri);
      if (m) {
        const chosen = pickByLang(m, lang);
        if (chosen.length) return chosen[0];
      }
      return uri.split("/").pop();
    }

    listEl.innerHTML = "";

    if (!plants.length) {
      listEl.innerHTML = "<p><em>No iroko:Plant records found.</em></p>";
      return;
    }

    for (const p of plants) {
      const lbl = LABELS[lang] || LABELS["en"];

      const yo = (p.altByLang["yo"] || [])
        .concat(p.prefByLang?.["yo"] || [])
        .filter((v,i,a) => a.indexOf(v) === i)
        .join("; ") || "—";

      const enAlt    = (p.altByLang["en"]          || []).join("; ") || "—";
      const esCuAlt  = (p.altByLang["es-cu"]        || []).join("; ");
      const esAlt    = (p.altByLang["es"]           || []).filter(v => !esCuAlt.includes(v)).join("; ");
      const ptAlt    = (p.altByLang["pt"]           || []).join("; ");
      const frAlt    = (p.altByLang["fr"]           || []).join("; ");
      const htAlt    = (p.altByLang["ht"]           || []).join("; ");
      const lucumiAlt = (p.altByLang["yo-x-lucumi"] || []).join("; ");
      const synText  = (p.synonyms && p.synonyms.length) ? p.synonyms.join("; ") : null;

      const access = p.access.length   ? p.access.map(u   => labelize(u)).join(", ") : "—";
      const med    = p.medicinal.length ? p.medicinal.map(u => labelize(u)).join(", ") : "—";
      const rit    = p.ritual.length    ? p.ritual.map(u   => labelize(u)).join(", ") : "—";

      const collisionNotes = pickByLang(p.collisionNoteByLang, lang);
      const collisionItems = collisionNotes.map(t => `<li>${t}</li>`).join("");

      const ritualNotes = pickByLang(p.ritualNoteByLang, lang);
      const ritualItems = ritualNotes.map(t => `<li>${t}</li>`).join("");

      // Resolve named-node sources to Chicago citations
      const resolvedSources = p.sourceUris.map(uri => {
        const bibRec = p._bibNodes && p._bibNodes[uri];
        if (bibRec && bibRec.length) return bibRec[0];
        const m = conceptLabels.get(uri);
        if (m) { const c = pickByLang(m, lang); if (c.length) return c[0]; }
        return uri.split("/").pop();
      });
      const allSources = p.source.concat(resolvedSources);

      const links = p.links.filter(x => typeof x === "string" && (x.startsWith("http://") || x.startsWith("https://")));

      // Build card HTML
      const card = document.createElement("div");
      card.className = "plant-card";

      card.innerHTML = `
        <div class="plant-card-header">
          <div class="plant-sci">${p.sci || lbl.noSci}</div>
          <div class="plant-id">${p.id || p.uri.split("/").pop()}</div>
        </div>
        ${synText ? `<div class="plant-syn"><strong>${lbl.syn}:</strong> ${synText}</div>` : ""}

        <div class="plant-names">
          <div class="plant-name-row yo"><strong>${lbl.yo}:</strong> ${yo}</div>
          <div class="primary-form-note">${lbl.primaryForm}</div>
          <div class="plant-name-row"><strong>${lbl.en}:</strong> ${enAlt}</div>
          ${esCuAlt ? `<div class="plant-name-row"><strong>${lbl["es-cu"]}:</strong> ${esCuAlt}</div>`
                    : esAlt ? `<div class="plant-name-row"><strong>${lbl.es}:</strong> ${esAlt}</div>` : ""}
          ${ptAlt     ? `<div class="plant-name-row"><strong>${lbl.pt}:</strong> ${ptAlt}</div>` : ""}
          ${frAlt     ? `<div class="plant-name-row"><strong>${lbl.fr}:</strong> ${frAlt}</div>` : ""}
          ${htAlt     ? `<div class="plant-name-row"><strong>${lbl.ht}:</strong> ${htAlt}</div>` : ""}
          ${lucumiAlt ? `<div class="plant-name-row"><strong>${lbl.lucumi}:</strong> ${lucumiAlt}</div>` : ""}
        </div>

        ${collisionItems ? `
        <div class="plant-collision">
          <strong>${lbl.collision}:</strong>
          <ul>${collisionItems}</ul>
        </div>` : ""}

        <div class="plant-categories">
          <strong>${lbl.access}:</strong> ${access}<br>
          <strong>${lbl.medicinal}:</strong> ${med}<br>
          <strong>${lbl.ritual}:</strong> ${rit}
        </div>

        ${ritualItems ? `
        <div class="plant-ritual-note">
          <strong>${lbl.ritualNote}:</strong>
          <ul>${ritualItems}</ul>
        </div>` : ""}

        ${allSources.length ? `
        <div class="plant-sources">
          <strong>${lbl.sources}</strong>
          <div class="plant-source-list">
            ${allSources.map(s => `<div class="plant-source-item">${s}</div>`).join("")}
          </div>
        </div>` : ""}

        ${links.length ? `
        <div class="plant-links">
          <strong>${lbl.links}:</strong>
          ${links.map(u => `<a href="${u}" target="_blank" rel="noopener noreferrer">${lbl.extRecord}</a>`).join(" | ")}
        </div>` : ""}

        <div class="plant-uri">${p.uri}</div>
      `;

      listEl.appendChild(card);
    }

    window._renderedLangs.add(lang);
  }

  // ── RDF graph loader ──────────────────────────────────────────
  async function loadPlantsGraph() {
    const PLANTS_TTL = "../data/ewe-plants-v0.2.1.ttl";
    const VOCAB_TTL  = "../data/iroko-vocab-v0.2.1.ttl";

    try {
      const [plantsText, vocabText] = await Promise.all([
        fetchText(PLANTS_TTL),
        fetchText(VOCAB_TTL)
      ]);

      const parser = new N3.Parser();
      const quads  = parser.parse(plantsText + "\n\n" + vocabText);

      // Predicate URIs
      const RDF_TYPE       = "http://www.w3.org/1999/02/22-rdf-syntax-ns#type";
      const SKOS_PREF      = "http://www.w3.org/2004/02/skos/core#prefLabel";
      const SKOS_ALT       = "http://www.w3.org/2004/02/skos/core#altLabel";
      const DCT_ID         = "http://purl.org/dc/terms/identifier";
      const DCT_SOURCE     = "http://purl.org/dc/terms/source";
      const DCT_REL        = "http://purl.org/dc/terms/relation";
      const DCT_BIB        = "http://purl.org/dc/terms/bibliographicCitation";
      const DWC_SCI        = "http://rs.tdwg.org/dwc/terms/scientificName";
      const IROKO_PLANT    = "https://www.irokosociety.org/iroko-framework/ewe/Plant";
      const IROKO_ACCESS   = "https://www.irokosociety.org/iroko-framework/ewe/hasAccessLevel";
      const IROKO_MED      = "https://www.irokosociety.org/iroko-framework/ewe/hasMedicinalCategory";
      const IROKO_RIT      = "https://www.irokosociety.org/iroko-framework/ewe/hasRitualCategory";
      const IROKO_COL_FLAG = "https://www.irokosociety.org/iroko-framework/ewe/nameCollisionFlag";
      const IROKO_COL_NOTE = "https://www.irokosociety.org/iroko-framework/ewe/nameCollisionNote";
      const IROKO_RIT_NOTE = "https://www.irokosociety.org/iroko-framework/ewe/ritualContextNote";

      const conceptLabels = new Map();  // URI → { lang: [labels] }
      const bibCitations  = new Map();  // URI → [citation strings]
      const bySubject     = new Map();
      const plantSubjects = new Set();

      for (const q of quads) {
        const s = q.subject.value;
        const p = q.predicate.value;
        const o = q.object;

        // skos:prefLabel — concept lookup map AND plant prefByLang
        if (p === SKOS_PREF && o.termType === "Literal") {
          const lang = (o.language || "en").toLowerCase();
          if (!conceptLabels.has(s)) conceptLabels.set(s, {});
          const m = conceptLabels.get(s);
          if (!m[lang]) m[lang] = [];
          m[lang].push(o.value);

          if (!bySubject.has(s)) initRec(bySubject, s);
          const rec2 = bySubject.get(s);
          if (!rec2.prefByLang[lang]) rec2.prefByLang[lang] = [];
          rec2.prefByLang[lang].push(o.value);
        }

        // dcterms:bibliographicCitation — store on bib node
        if (p === DCT_BIB && o.termType === "Literal") {
          if (!bibCitations.has(s)) bibCitations.set(s, []);
          bibCitations.get(s).push(o.value);
        }

        // Track plant type
        if (p === RDF_TYPE && o.value === IROKO_PLANT) plantSubjects.add(s);

        if (!bySubject.has(s)) initRec(bySubject, s);
        const rec = bySubject.get(s);

        if (p === DCT_ID  && o.termType === "Literal") rec.id  = o.value;
        if (p === DWC_SCI && o.termType === "Literal") rec.sci = o.value;

        if (p === SKOS_ALT && o.termType === "Literal") {
          const lang = (o.language || "").toLowerCase();
          if (lang === "") {
            rec.synonyms.push(o.value);       // untagged = scientific synonym
          } else {
            if (!rec.altByLang[lang]) rec.altByLang[lang] = [];
            rec.altByLang[lang].push(o.value);
          }
        }

        if (p === IROKO_COL_FLAG && o.termType === "Literal") rec.collisionFlag = o.value;

        if (p === IROKO_COL_NOTE && o.termType === "Literal") {
          const lang = (o.language || "en").toLowerCase();
          if (!rec.collisionNoteByLang[lang]) rec.collisionNoteByLang[lang] = [];
          rec.collisionNoteByLang[lang].push(o.value);
        }

        if (p === IROKO_RIT_NOTE && o.termType === "Literal") {
          const lang = (o.language || "en").toLowerCase();
          if (!rec.ritualNoteByLang[lang]) rec.ritualNoteByLang[lang] = [];
          rec.ritualNoteByLang[lang].push(o.value);
        }

        if (p === IROKO_ACCESS && o.termType === "NamedNode") rec.access.push(o.value);
        if (p === IROKO_MED   && o.termType === "NamedNode") rec.medicinal.push(o.value);
        if (p === IROKO_RIT   && o.termType === "NamedNode") rec.ritual.push(o.value);

        if (p === DCT_SOURCE && o.termType === "Literal")   rec.source.push(o.value);
        if (p === DCT_SOURCE && o.termType === "NamedNode") rec.sourceUris.push(o.value);
        if (p === DCT_REL)                                  rec.links.push(o.value);
      }

      // Attach resolved bib citations to each plant record
      const plants = Array.from(plantSubjects)
        .map(u => bySubject.get(u))
        .filter(Boolean)
        .sort((a, b) => (a.sci || "").localeCompare(b.sci || ""));

      for (const plant of plants) {
        plant._bibNodes = {};
        for (const uri of plant.sourceUris) {
          plant._bibNodes[uri] = bibCitations.get(uri) || [];
        }
      }

      // Store globally so setLang() can trigger lazy renders
      window._plantsData    = plants;
      window._conceptLabels = conceptLabels;
      window._renderedLangs = new Set();

      // Update all status messages
      document.querySelectorAll(".load-status").forEach(el => {
        el.textContent = "Loaded " + plants.length + " plant record(s).";
      });

      // Render into all 5 panels at load time
      ["en", "es", "pt", "fr", "yo"].forEach(lang => {
        renderPlants(lang, plants, conceptLabels);
      });

    } catch (err) {
      document.querySelectorAll(".load-status").forEach(el => {
        el.textContent = "Error loading RDF graph.";
      });
      document.querySelectorAll("[id^='plant-list-']").forEach(el => {
        el.innerHTML = "<p><em>" + err.message + "</em></p>";
      });
      console.error(err);
    }
  }

  function initRec(bySubject, s) {
    bySubject.set(s, {
      uri: s, id: null, sci: null,
      altByLang: {}, prefByLang: {}, synonyms: [],
      collisionFlag: null, collisionNoteByLang: {}, ritualNoteByLang: {},
      access: [], medicinal: [], ritual: [],
      source: [], sourceUris: [], links: [],
      _bibNodes: {}
    });
  }

  window.addEventListener("DOMContentLoaded", loadPlantsGraph);
</script>

</body>
</html>
